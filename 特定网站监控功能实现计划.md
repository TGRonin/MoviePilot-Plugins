# MoviePilot插件实现计划

## 需求分析
- 参考提供的MoviePilot插件开发教程，实现群聊区监控插件
- 监控特定格式的魔法上传信息：`完成了一次上传x.xx下载0.00的魔法, 持续1天0小时`
- 支持配置化管理，包括监控目标、检查间隔、匹配规则等
- 集成到MoviePilot的通知系统
- 支持去重功能，避免重复通知

## 技术方案

### 1. 插件目录结构
```
groupchatzone/          # 插件目录，与插件类名小写一致
├── __init__.py         # 插件主类
├── plugin.json         # 插件配置信息
├── requirements.txt    # 插件依赖（如果有）
└── README.md           # 插件说明文档
```

### 2. 插件主类设计
```python
from app.plugins import PluginBase, PluginManager
from app.plugins import EventManager, EventType
from app.schemas import NotificationType
from app.helper import BrowserHelper
from app.utils import RequestUtils
import re
import time
import threading

class GroupChatZone(PluginBase):
    # 插件元信息
    plugin_id = "groupchatzone"
    plugin_name = "群聊区监控"
    plugin_desc = "监控群聊区特定格式的魔法上传信息"
    plugin_icon = "https://example.com/icon.png"
    plugin_author = "Your Name"
    plugin_version = "1.0.0"
    plugin_language = "zh"
    
    # 插件配置项
    enable = False
    target_url = ""
    check_interval = 120  # 检查间隔（秒）
    match_pattern = r"完成了一次上传\d+\.\d{2}下载0\.00的魔法, 持续\d+天\d+小时"
    notification_enable = True
    notification_channel = None
    
    # 内部属性
    _monitor_thread = None
    _monitor_running = False
    _detected_contents = set()
    _last_check_time = 0
    
    def init_plugin(self, config):
        # 初始化插件配置
        pass
    
    def get_state(self):
        # 获取插件运行状态
        return self._monitor_running
    
    def get_form(self):
        # 获取插件配置表单
        pass
    
    def get_page(self):
        # 获取插件详情页面
        pass
    
    def get_api(self):
        # 获取插件API
        pass
    
    def start_monitor(self):
        # 启动监控线程
        pass
    
    def stop_monitor(self):
        # 停止监控线程
        pass
    
    def monitor_task(self):
        # 监控任务
        pass
    
    def fetch_iframe_content(self):
        # 获取iframe内容
        pass
    
    def detect_target_content(self, content):
        # 检测目标内容
        pass
    
    def send_notification(self, matched_content):
        # 发送通知
        pass
    
    def stop_service(self):
        # 停止插件服务
        pass
```

### 3. 核心功能实现

#### 3.1 初始化与配置
- 实现`init_plugin`方法，加载插件配置
- 实现`get_form`方法，生成配置表单
- 支持配置：监控开关、目标URL、检查间隔、匹配规则、通知设置

#### 3.2 监控功能
- 使用BrowserHelper访问目标URL
- 提取iframe内容
- 使用正则表达式匹配特定格式
- 实现去重机制
- 定时检查，支持动态调整检查间隔

#### 3.3 事件与通知
- 集成MoviePilot的事件系统
- 支持发送通知到MoviePilot的通知中心
- 支持多种通知渠道

#### 3.4 线程管理
- 实现监控线程的启动和停止
- 支持插件的动态开关
- 确保线程安全

### 4. 插件配置表单
```python
def get_form(self):
    return {
        "enable": {
            "label": "启用插件",
            "type": "switch",
            "value": self.enable
        },
        "target_url": {
            "label": "目标URL",
            "type": "input",
            "value": self.target_url,
            "placeholder": "请输入群聊区URL"
        },
        "check_interval": {
            "label": "检查间隔（秒）",
            "type": "input",
            "value": self.check_interval,
            "placeholder": "请输入检查间隔，单位：秒"
        },
        "match_pattern": {
            "label": "匹配规则",
            "type": "input",
            "value": self.match_pattern,
            "placeholder": "请输入正则表达式"
        },
        "notification_enable": {
            "label": "启用通知",
            "type": "switch",
            "value": self.notification_enable
        },
        "notification_channel": {
            "label": "通知渠道",
            "type": "select",
            "value": self.notification_channel,
            "options": [
                {"label": "系统通知", "value": "system"},
                {"label": "邮件通知", "value": "email"},
                {"label": "其他渠道", "value": "other"}
            ]
        }
    }
```

### 5. 监控逻辑实现
```python
def monitor_task(self):
    """监控任务"""
    while self._monitor_running:
        try:
            # 检查是否到检查时间
            now = time.time()
            if now - self._last_check_time < self.check_interval:
                time.sleep(1)
                continue
            
            self._last_check_time = now
            
            # 获取iframe内容
            content = self.fetch_iframe_content()
            if not content:
                continue
            
            # 检测目标内容
            self.detect_target_content(content)
            
        except Exception as e:
            self.logger.error(f"监控任务执行失败：{e}")
            time.sleep(1)
    
def fetch_iframe_content(self):
    """获取iframe内容"""
    try:
        # 使用BrowserHelper访问目标URL
        browser = BrowserHelper()
        html = browser.get(self.target_url)
        if not html:
            return None
        
        # 解析HTML，提取iframe内容
        # 这里需要根据实际情况实现iframe内容提取逻辑
        # 可以使用BeautifulSoup或正则表达式
        
        return extracted_content
    except Exception as e:
        self.logger.error(f"获取iframe内容失败：{e}")
        return None
    
def detect_target_content(self, content):
    """检测目标内容"""
    try:
        # 使用正则表达式匹配目标内容
        pattern = re.compile(self.match_pattern)
        matches = pattern.findall(content)
        
        # 处理匹配结果，去重
        for match in matches:
            if match not in self._detected_contents:
                # 新内容，添加到已检测集合
                self._detected_contents.add(match)
                # 发送通知
                self.send_notification(match)
                self.logger.info(f"检测到新内容：{match}")
    except Exception as e:
        self.logger.error(f"检测目标内容失败：{e}")
```

### 6. 通知机制
```python
def send_notification(self, matched_content):
    """发送通知"""
    if not self.notification_enable:
        return
    
    try:
        # 构建通知内容
        title = "群聊区监控通知"
        text = f"检测到特定格式的魔法上传信息：{matched_content}"
        
        # 使用MoviePilot的事件系统发送通知
        self.eventmanager.send_event(
            EventType.NoticeMessage,
            {
                "channel": self.notification_channel,
                "type": NotificationType.info,
                "title": title,
                "text": text,
                "userid": None
            }
        )
    except Exception as e:
        self.logger.error(f"发送通知失败：{e}")
```

## 实现步骤

1. **创建插件目录结构**
   - 创建`groupchatzone`目录
   - 创建`__init__.py`、`plugin.json`、`requirements.txt`和`README.md`文件

2. **实现插件主类**
   - 继承自`PluginBase`
   - 实现插件元信息
   - 实现初始化和配置方法
   - 实现监控功能
   - 实现通知机制

3. **实现插件配置表单**
   - 使用配置化方式组装表单
   - 支持动态调整监控参数

4. **实现监控逻辑**
   - 使用BrowserHelper访问目标URL
   - 提取iframe内容
   - 实现正则表达式匹配
   - 实现去重机制

5. **集成通知系统**
   - 使用MoviePilot的事件系统发送通知
   - 支持多种通知渠道

6. **测试和调试**
   - 在本地开发环境中测试插件功能
   - 调试监控逻辑和通知机制
   - 测试不同配置下的表现

7. **发布插件**
   - 按照MoviePilot插件发布流程发布插件
   - 提供插件使用说明和更新日志

## 预期效果

- 插件能够在MoviePilot中正常安装和运行
- 支持配置监控目标、检查间隔和匹配规则
- 能够实时监控群聊区iframe内容
- 当检测到特定格式的魔法上传信息时，发送通知
- 支持去重功能，避免重复通知
- 集成到MoviePilot的通知系统

## 注意事项

1. **遵循MoviePilot插件规范**
   - 确保插件目录结构和命名符合要求
   - 确保插件主类和方法签名正确
   - 确保配置表单格式正确

2. **处理异常情况**
   - 处理网络请求失败的情况
   - 处理HTML解析失败的情况
   - 处理正则表达式匹配失败的情况

3. **优化性能**
   - 合理设置检查间隔，避免过度消耗资源
   - 优化iframe内容提取逻辑
   - 合理管理线程资源

4. **安全考虑**
   - 避免在插件中硬编码敏感信息
   - 确保插件代码符合安全规范
   - 避免引入不安全的依赖

5. **文档完善**
   - 提供详细的插件使用说明
   - 提供配置示例
   - 提供常见问题解答

通过以上实现计划，我们可以将之前的iframe监控功能转换为符合MoviePilot规范的插件，实现群聊区特定内容的监控和通知功能。